package com.soft.action;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Iterator;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.apache.struts2.interceptor.ServletRequestAware;
import org.apache.struts2.interceptor.ServletResponseAware;

import com.opensymphony.xwork2.ActionSupport;
import com.soft.model.Repair;
import com.soft.model.ReportRepair;
import com.soft.service.DiaoDuGuanLiService;

public class DiaoDuAction extends ActionSupport implements ServletRequestAware,ServletResponseAware{
	private HttpServletRequest request;
	private HttpServletResponse response;
	private DiaoDuGuanLiService diaoDuGuanLiService;
	private ReportRepair reportRepair;
	private Repair Repair;
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	
	/*
	 * 分页查询所有
	 * 列出所有待分配任务
	 * 查询报修记录表
	 * 
	 */
public void queryAllReportRepair(){
	

	int page = Integer.valueOf(request.getParameter("page")==null?"1":request.getParameter("page"));
	int pageSize = Integer.valueOf(request.getParameter("rows")==null?"5":request.getParameter("rows"));
	
	List<ReportRepair> customList = diaoDuGuanLiService.queryAllReportRepair(page,pageSize);


	Iterator<ReportRepair> iterator = customList.iterator();
	JSONArray jsonArray = new JSONArray();
	JSONObject finalObj = new JSONObject();
	// 统计数据总行数 分页
	finalObj.put("total", diaoDuGuanLiService.countAllTask());

	while(iterator.hasNext())
	{
		JSONObject obj = new JSONObject();
		
		ReportRepair custom =  iterator.next();
		obj.put("customId", custom.getCustomId());
		
		jsonArray.add(obj);
	}
	System.out.println(jsonArray.toString());
	finalObj.put("rows", jsonArray);
	//System.out.println("-----"+finalObj.toString()+"-----");
	  response.setContentType("text/html;charset=UTF-8");
	  PrintWriter out = null;
	try {
		out = response.getWriter();
	} catch (IOException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	}   
	   
	   out.println(finalObj.toString());   
	   out.flush();   
	   out.close();   
	
}
	/*
	 * 选中某条待分配任务，为其分配工程师，修改
	 * 报修 表，并且在维修记录表添加一条数据
	 */
public void fenpeiWeixiushi(){
	System.out.println("");
	diaoDuGuanLiService.fenpeiWeixiushi(Repair);
	JSONObject finalObj = new JSONObject();
	System.out.println("536455");
	

		
		finalObj.put("info", "修改成功");
		
		  response.setContentType("text/html;charset=UTF-8");
		  PrintWriter out = null;
		try {
			out = response.getWriter();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}   
		   
		   out.println(finalObj.toString());   
		   out.flush();   
		   out.close();   
	
	
}
/*
 * 
 * 统计维修师傅的工作情况，便于分配任务
 * 查询维修记录表，列出各工程师目前正在进行的任务数量
 * 方便参考，偏于分配任务
 */
public void tongjiWeixiushiGongzuo(){

	int page = Integer.valueOf(request.getParameter("page")==null?"1":request.getParameter("page"));
	int pageSize = Integer.valueOf(request.getParameter("rows")==null?"5":request.getParameter("rows"));
	
	List<Repair> customList = diaoDuGuanLiService.tongjiWeixiushiGongzuo(page,pageSize);


	Iterator<Repair> iterator = customList.iterator();
	JSONArray jsonArray = new JSONArray();
	JSONObject finalObj = new JSONObject();
	// 统计数据总行数 分页
	finalObj.put("total", diaoDuGuanLiService.countAllWeixiushi());

	while(iterator.hasNext())
	{
		JSONObject obj = new JSONObject();
		
		Repair Repair =  iterator.next();
		obj.put("customId", Repair.getRepairId());
		
		jsonArray.add(obj);
	}
	System.out.println(jsonArray.toString());
	finalObj.put("rows", jsonArray);
	//System.out.println("-----"+finalObj.toString()+"-----");
	  response.setContentType("text/html;charset=UTF-8");
	  PrintWriter out = null;
	try {
		out = response.getWriter();
	} catch (IOException e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	}   
	   
	   out.println(finalObj.toString());   
	   out.flush();   
	   out.close();   
	
	
}

public DiaoDuGuanLiService getDiaoDuGuanLiService() {
	return diaoDuGuanLiService;
}
public void setDiaoDuGuanLiService(DiaoDuGuanLiService diaoDuGuanLiService) {
	this.diaoDuGuanLiService = diaoDuGuanLiService;
}
public ReportRepair getReportRepair() {
	return reportRepair;
}
public void setReportRepair(ReportRepair reportRepair) {
	this.reportRepair = reportRepair;
}
public Repair getRepair() {
	return Repair;
}
public void setRepair(Repair repair) {
	Repair = repair;
}
@Override
public void setServletRequest(HttpServletRequest request) {
this.request=request;
	
}
@Override
public void setServletResponse(HttpServletResponse reponse) {
	this.response=response;
	
}
}
